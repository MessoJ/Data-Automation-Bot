{% extends "base.html" %}

{% block title %}Reports - E-commerce Data Automation{% endblock %}

{% block content %}
<div class="reports-page">
    <div class="page-header">
        <h1 class="page-title">Reports &amp; Analytics</h1>
        <p class="page-subtitle">Generate and manage your e-commerce performance reports</p>
    </div>

    <!-- Report Generation Section -->
    <div class="reports-section">
        <div class="section-header">
            <h2 class="section-title">Generate New Report</h2>
            <div class="report-actions">
                <button class="premium-btn primary" onclick="generateQuickReport()">
                    <span class="btn-icon" aria-hidden="true">üìÑ</span>
                    <span class="btn-text">Quick Report</span>
                </button>
            </div>
        </div>

        <div class="report-generator">
            <div class="generator-options">
                <div class="option-group">
                    <label class="option-label">Report Type</label>
                    <select id="reportType" class="option-select">
                        <option value="inventory">Inventory Report</option>
                        <option value="revenue">Revenue Report</option>
                        <option value="discrepancies">Discrepancies Report</option>
                        <option value="performance">Performance Report</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label class="option-label">Format</label>
                    <select id="reportFormat" class="option-select">
                        <option value="csv">CSV</option>
                        <option value="html">HTML</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label class="option-label">Time Period</label>
                    <select id="timePeriod" class="option-select">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
            </div>
            
            <button class="premium-btn primary large" onclick="generateCustomReport()">
                <span class="btn-icon" aria-hidden="true">üìù</span>
                <span class="btn-text">Generate Report</span>
            </button>
        </div>
    </div>

    <!-- Available Reports -->
    <div class="available-reports">
        <div class="section-header">
            <h2 class="section-title">Available Reports</h2>
            <button class="refresh-btn" onclick="refreshReports()">
                <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
            </button>
        </div>

        <div class="reports-list" id="reportsList">
            <div class="loading-placeholder">
                <div class="loading-spinner"></div>
                <p>Loading reports...</p>
            </div>
        </div>
    </div>
</div>

<style>
.reports-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-6);
}

.page-header {
    margin-bottom: var(--space-8);
    text-align: center;
}

.page-title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--neutral-800);
    margin-bottom: var(--space-2);
}

.page-subtitle {
    font-size: var(--text-lg);
    color: var(--neutral-600);
}

.reports-section {
    background: var(--bg-primary);
    border-radius: var(--radius-2xl);
    padding: var(--space-8);
    margin-bottom: var(--space-8);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--neutral-200);
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-6);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--neutral-800);
}

.report-generator {
    background: var(--neutral-50);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    border: 1px solid var(--neutral-200);
}

.generator-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-6);
}

.option-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.option-label {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--neutral-700);
}

.option-select {
    padding: var(--space-3);
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    background: var(--bg-primary);
    font-size: var(--text-sm);
    color: var(--neutral-700);
    transition: all var(--transition-fast);
}

.option-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(22, 160, 133, 0.1);
}

.available-reports {
    background: var(--bg-primary);
    border-radius: var(--radius-2xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--neutral-200);
}

.reports-list {
    display: grid;
    gap: var(--space-4);
}

.report-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
    transition: all var(--transition-fast);
}

.report-item:hover {
    background: var(--bg-primary);
    box-shadow: var(--shadow-md);
}

.report-info {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.report-icon {
    width: 40px;
    height: 40px;
    background: var(--primary-color);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: var(--text-lg);
}

.report-details h4 {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--neutral-800);
    margin-bottom: var(--space-1);
}

.report-details p {
    font-size: var(--text-sm);
    color: var(--neutral-600);
}

.report-actions {
    display: flex;
    gap: var(--space-2);
}

.loading-placeholder {
    text-align: center;
    padding: var(--space-8);
    color: var(--neutral-500);
}

.premium-btn.large {
    padding: var(--space-4) var(--space-8);
    font-size: var(--text-lg);
}

@media (max-width: 768px) {
    .generator-options {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        gap: var(--space-4);
        align-items: stretch;
    }
    
    .report-item {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-4);
    }
    
    .report-actions {
        justify-content: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
});

function generateQuickReport() {
    generateCustomReport('inventory', 'html', 30);
}

function generateCustomReport(type = null, format = null, period = null) {
    const reportType = type || document.getElementById('reportType').value;
    const reportFormat = format || document.getElementById('reportFormat').value;
    const timePeriod = period || document.getElementById('timePeriod').value;
    
    showGlobalToast(`Generating ${reportType} report...`, 'info');
    
    fetch('/api/reports/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            report_type: reportType,
            format: reportFormat,
            period: timePeriod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showGlobalToast('Report generated successfully!', 'success');
            setTimeout(loadReports, 1000);
        } else {
            showGlobalToast('Failed to generate report', 'error');
        }
    })
    .catch(error => {
        showGlobalToast('Error generating report', 'error');
    });
}

function loadReports() {
    const reportsList = document.getElementById('reportsList');
    reportsList.innerHTML = '<div class="loading-placeholder"><div class="loading-spinner"></div><p>Loading reports...</p></div>';
    
    fetch('/api/reports')
        .then(response => response.json())
        .then(data => {
            displayReports(data.reports || []);
        })
        .catch(error => {
            reportsList.innerHTML = '<div class="loading-placeholder"><p>Error loading reports</p></div>';
        });
}

function displayReports(reports) {
    const reportsList = document.getElementById('reportsList');
    
    if (reports.length === 0) {
        reportsList.innerHTML = '<div class="loading-placeholder"><p>No reports available</p></div>';
        return;
    }
    
    reportsList.innerHTML = reports.map(report => `
        <div class="report-item">
            <div class="report-info">
                <div class="report-icon" aria-hidden="true">üìÑ</div>
                <div class="report-details">
                    <h4>${report.filename}</h4>
                    <p>Size: ${formatFileSize(report.size)} | Created: ${new Date(report.created).toLocaleDateString()}</p>
                </div>
            </div>
            <div class="report-actions">
                <button class="premium-btn secondary" onclick="downloadReport('${report.filename}')">Download</button>
            </div>
        </div>
    `).join('');
}

function downloadReport(filename) {
    window.open(`/api/reports/download/${filename}`, '_blank');
    showGlobalToast(`Downloading ${filename}`, 'success');
}

function refreshReports() {
    loadReports();
    showGlobalToast('Reports refreshed', 'info');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}