{% extends "base.html" %}
{% block title %}Stores{% endblock %}
{% block content %}
<div class="container" style="max-width: 960px; margin: 0 auto; padding: var(--space-6);">
  <div class="d-flex items-center justify-between mb-4">
    <h1>Stores</h1>
  </div>
  <div class="card mb-6">
    <div class="card-header"><h2 class="card-title">Create / Update Store</h2></div>
    <div class="card-body">
      <form id="storeForm" onsubmit="return saveStore(event)">
        <input type="hidden" id="storeId" />
        <div class="d-grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label>Name</label>
            <input id="storeName" class="input" placeholder="My Store" />
          </div>
          <div>
            <label>Domain</label>
            <input id="storeDomain" class="input" placeholder="mystore.example.com" />
          </div>
          <div>
            <label>Theme</label>
            <select id="storeTheme" class="input">
              <option value="default">default</option>
              <option value="minimal">minimal</option>
            </select>
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h2 class="card-title">All Stores</h2></div>
    <div class="card-body">
      <div id="storesList">Loading...</div>
    </div>
  </div>
</div>
<script>
async function fetchStores(){
  const res = await fetch('/api/stores');
  const data = await res.json();
  const list = document.getElementById('storesList');
  list.innerHTML = (data.stores||[]).map(s=>`
    <div class="d-flex items-center justify-between mb-2">
      <div>
        <div><strong>${s.name}</strong> <span class="text-sm">(${s.domain||'no-domain'})</span></div>
        <div class="text-sm">Theme: <code>${s.theme||'default'}</code></div>
      </div>
      <div>
        <a class="btn btn-sm" href="/store/${s.domain || s.id}?theme=${encodeURIComponent(s.theme||'default')}">Preview</a>
        <button class="btn btn-sm btn-secondary" onclick='editStore(${JSON.stringify(s)})'>Edit</button>
      </div>
    </div>
  `).join('');
}

function editStore(s){
  document.getElementById('storeId').value = s.id;
  document.getElementById('storeName').value = s.name || '';
  document.getElementById('storeDomain').value = s.domain || '';
  document.getElementById('storeTheme').value = s.theme || 'default';
}

async function saveStore(e){ e.preventDefault();
  const payload = {
    id: document.getElementById('storeId').value || undefined,
    name: document.getElementById('storeName').value,
    domain: document.getElementById('storeDomain').value,
    theme: document.getElementById('storeTheme').value,
  };
  const url = payload.id ? `/api/stores/${payload.id}` : '/api/stores';
  const method = payload.id ? 'PUT' : 'POST';
  const res = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(res.ok){
    document.getElementById('storeId').value='';
    document.getElementById('storeName').value='';
    document.getElementById('storeDomain').value='';
    document.getElementById('storeTheme').value='default';
    fetchStores();
  }
  return false;
}

document.addEventListener('DOMContentLoaded', fetchStores);
</script>
{% endblock %}